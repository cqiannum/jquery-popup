/*! Popup - v0.1.0 - 2013-07-04
* https://github.com/amazingSurge/popup
* Copyright (c) 2013 amazingSurge; Licensed CC, BY-NC */
(function(t,e,i,n){"use strict";var o=t(e),s=t.popup=function(e,i){this.$element=t(e),this.$target=null,this.active=!1,this.isGroup=!1,this.group=[],this.index=0,this.total=0,this.type="",this.url="",i||(i={}),this.options=t.extend({},s.defaults,this.themes[i.theme],i),this.namespace=this.options.namespace,this.init()};s.prototype={constructor:s,themes:{},components:{},init:function(){var e=this;o.trigger("popup::init",this),this.$element.on("click",function(){var n,o,s;return s=t(this).data("popup-group"),o=e.filterGroup(s,e.$element),n=t(o).index(this)||0,e.group=e.getGroupConfig.call(e,o),o.length>1&&(e.isGroup=!0,e.total=o.length),e.open(),e.goto(n),t(i).on("resize.popup",t.proxy(e.resize,e)),!1})},filterGroup:function(e,i){var o=null;return o=1===i.length?i:i.filter(function(){var i=t(this).data("popup-group");return e?i===e:n})},getGroupConfig:function(e){var i=[],n=this;return t.isArray(e)?e:(t.each(e,function(e,o){var s={},a=t(o).attr("href"),p={url:a,target:o,type:n.options.type||n.checkType(a)};t.each(t(o).data(),function(t,e){/^popup/i.test(t)&&(s[t.toLowerCase().replace(/^popup/i,"")]=e)}),p.options=s,s.type&&(p.type=s.type),i.push(p)}),i)},create:function(){var e=this.options;this.$overlay=t(e.tpl.overlay),this.$wrap=t(e.tpl.container),this.$close=t(e.tpl.close),this.$loading=t(e.tpl.loading),this.$container=this.$wrap.find("."+this.namespace+"-container"),this.$contentWrap=this.$container.find("."+this.namespace+"-content-wrap"),this.$contentHolder=this.$contentWrap.find("."+this.namespace+"-content-holder"),this.$content=this.$container.find("."+this.namespace+"-content"),this.$title=this.$container.find("."+this.namespace+"-title"),this.$counter=this.$container.find("."+this.namespace+"-counter"),this.bindEvent(),this.isGroup&&(this.$next=t(e.tpl.next).appendTo(this.$container),this.$prev=t(e.tpl.prev).appendTo(this.$container),this.$next.on("click",t.proxy(this.next,this)),this.$prev.on("click",t.proxy(this.prev,this))),o.trigger("popup::create",this),this.$overlay.addClass(this.namespace+"-"+this.options.modalEffect+"-open"),this.$contentWrap.addClass(this.options.modalEffect),this.$overlay.addClass(this.options.modalEffect+"-overlay"),t("body").addClass(this.namespace+"-body"),this.$close.appendTo(this.$contentHolder).css({display:"none"}),this.$loading.appendTo(this.$container),this.$overlay.appendTo("body"),this.$wrap.appendTo("body")},open:function(){this.create(),this.active=!0},"goto":function(e){var i=t.Deferred(),n=this,s=this.group[e];this.settings=t.extend({},this.options,s.options),this.index=e,this.type=this.settings.type||s.type,this.title=this.settings.title,this.url=s.url,o.trigger("popup::change",this),this.$container.addClass(this.namespace+"-"+s.type+"-holder"),this.showLoading(),this.types[s.type].load(this,i),i.done(function(t){n.$close.css({display:"block"}),n.$content.empty().append(t),n.$title.text(n.title),n.isGroup&&n.$counter.text(n.index+1+"/"+n.total),setTimeout(function(){n.$contentWrap.addClass("we-show"),n.$overlay.addClass("we-show")},0),n.afterLoad()})},afterLoad:function(){o.trigger("popup::afterLoad",this),this.resize(),this.options.preload===!0&&this.preload()},next:function(){var t=this.index;return t++,t>=this.total&&(t=0),this.direction="next",this.goto(t),!1},prev:function(){var t=this.index;return t--,0>t&&(t=this.total-1),this.direction="prev",this.goto(t),!1},close:function(){var e=this;this.$contentWrap.removeClass("we-show"),this.$overlay.removeClass("we-show"),"none"===this.options.modalEffect?(this.$overlay.remove(),this.$wrap.remove(),t("body").removeClass(this.namespace+"-body")):setTimeout(function(){e.$overlay.remove(),e.$wrap.remove(),t("body").removeClass(e.namespace+"-body")},300),t(i).off("resize.popup"),o.trigger("popup::close",e),this.active=!1},preload:function(){o.trigger("popup::preload",this)},resize:function(){"image"===this.type&&this.types[this.type].resize(this),o.trigger("popup::resize",this)},bindEvent:function(){var e=this;this.$close.on("click",t.proxy(this.close,this)),this.options.winBtn===!0&&this.$wrap.on("click.popup",function(i){return t(i.target).hasClass(e.namespace+"-container")&&e.close.call(e),!1})},unbindEvent:function(){this.$wrap.off("click.popup")},checkType:function(e){var i=null;if(t.each(this.types,function(n,o){"function"===t.type(o.match)&&o.match(e)&&(i=o.match(e))}),i===!1)throw Error("unkonwn type !");return i},showLoading:function(){this.$loading.addClass(this.namespace+"-loading-show")},hideLoading:function(){this.$loading.removeClass(this.namespace+"-loading-show")}},s.defaults={namespace:"popup",theme:"default",modalEffect:"none",winBtn:!0,keyboard:!0,autoSlide:!1,playSpeed:1500,preload:!1,render:function(t){return t},retina:{ratio:2,replace:function(t){return t.replace(/\.\w+$/,function(t){return"@2x"+t})}},ajax:{render:function(e){return t(e)},options:{dataType:"html",headers:{popup:!0}}},swf:{allowscriptaccess:"always",allowfullscreen:"true",wmode:"transparent"},html5:{width:"100%",height:"100%",preload:"load",controls:"controls",poster:"",type:{mp4:"video/mp4",webm:"video/webm",ogg:"video/ogg"},source:null},thumbnail:!1,tpl:{overlay:'<div class="popup-overlay"></div>',container:'<div class="popup-wrap"><div class="popup-container"><div class="popup-content-wrap"><div class="popup-content-holder"><div class="popup-content"></div><div class="popup-infoBar"><div class="popup-title"></div><span class="popup-counter"></span></div></div></div></div></div>',loading:'<div class="popup-loading">loading...</div>',close:'<button title="Close" type="button" class="popup-close">x</button>',next:'<button title="next" type="button" class="popup-navigate popup-next"></button>',prev:'<button title="prev" type="button" class="popup-navigate popup-prev"></button>'}},s.prototype.types={image:{match:function(t){return t.match(/\.(png|PNG|jpg|JPG|jpeg|JPEG|gif|GIF)$/i)?"image":!1},getSize:function(t,e){var i,o=0,s=function(a){i&&clearInterval(i),i=setInterval(function(){return t.naturalWidth>0?(e(),clearInterval(i),n):t.width?(e(),clearInterval(i),n):(o>200&&clearInterval(i),o++,3===o?s(10):40===o?s(50):100===o&&s(500),n)},a)};s(1)},load:function(e,i){var o=this,s=new Image;s.src=e.url,t(s).addClass(e.namespace+"-image"),s.onload=function(){e.hideLoading(),e.$container.addClass(e.namespace+"-ready")},s.onerror=function(){this.onload=this.onerror=null,e.$container.addClass(e.namespace+"-fail"),e.hideLoading(),o.errorHandle()},s.complete!==n&&s.complete||e.showLoading(),this.getSize(s,function(){if("function"!==t.type(i.resolve))throw Error("dtd is not a deferred object !");i.resolve(s)})},resize:function(t){var e=t.$container.height();t.$content.find("img").css({"max-height":parseInt(e)-5})},errorHandle:function(){},preload:function(t){var e=new Image;e.src=t}},iframe:{match:function(t){return t.match(/\.(ppt|PPT|tif|TIF|pdf|PDF)$/i)?"iframe":!1},load:function(i,n){var o=e.createElement("iframe");o.src=i.url,o.attachEvent?o.attachEvent("onload",function(){i.hideLoading()}):o.onload=function(){i.hideLoading()},o.className=i.namespace+"-iframe",n.resolve(t(o))}},inline:{match:function(t){return"#"===t.charAt(0)?"inline":!1},load:function(e,i){var n=t(e.url).html();e.hideLoading(),i.resolve(n)}},ajax:{load:function(e,i){var n=e.settings.ajax;t.ajax(t.extend({},n.options,{url:e.url,error:function(){},success:function(o){var s;s="function"===t.type(n.render)?n.render(o):t(o),e.hideLoading(),i.resolve(s)}}))}},swf:{match:function(t){return t.match(/\.(swf)((\?|#).*)?$/i)?"swf":!1},load:function(e,i){var n="",o="",s=e.settings.swf;n+='<object class="'+e.namespace+'-swf" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="100%" height="100%">',n+='<param name="movie" value="'+e.url+'"></param>',t.each(s,function(t,e){n+='<param name="'+t+'" value="'+e+'"></param>',o+=" "+t+'="'+e+'"'}),n+='<embed src="'+e.url+'" type="application/x-shockwave-flash"  width="100%" height="100%"'+o+"></embed>",n+="</object>",e.hideLoading(),i.resolve(t(n))}},html5:{match:function(t){return t.match(/\.(mp4|webm|ogg)$/i)?"html5":!1},load:function(e,i){var n,o,s="",a=e.settings.html5;if(s+='<video class="'+e.namespace+'-html5"',s+=" width:"+a.width,s+=" height:"+a.height,s+=" "+a.preload,s+=" "+a.controls,s+=" poster:"+a.poster,s+=" >",n=e.url.split(","),0!==n.length)for(var p=0,r=n.length;r>p;p++)o=t.trim(n[p].split(".")[1]),s+='<source src="'+n[p]+'" type="'+a.type[o]+'"></source>';a.source&&0!==a.source.length&&t.each(a.source,function(t,e){s+='<source src="'+e.src+'" type="'+a.type[e.type]+'"></source>'}),s+="</video>",e.hideLoading(),i.resolve(t(s))}}},t.fn.popup=function(e){if("string"==typeof e){var i=e,o=arguments.length>1?Array.prototype.slice.call(arguments,1):n;return this.each(function(){var e=t.data(this,"popup");"function"==typeof e[i]&&e[i].apply(e,o)})}t(this).data("popup")||t(this).data("popup",new s(this,e))}})(jQuery,document,window),function(t){var e=$(t),i={keys:{UP:38,DOWN:40,LEFT:37,RIGHT:39,RETURN:13,ESCAPE:27,BACKSPACE:8,SPACE:32},map:{},bound:!1,press:function(t){var e=t.keyCode||t.which;e in i.map&&"function"==typeof i.map[e]&&i.map[e].call(self,t)},attach:function(t){var n,o;for(n in t)t.hasOwnProperty(n)&&(o=n.toUpperCase(),o in i.keys?i.map[i.keys[o]]=t[n]:i.map[o]=t[n]);i.bound||(i.bound=!0,e.bind("keydown",i.press))},detach:function(){i.bound=!1,i.map={},e.unbind("keydown",i.press)}};e.on("popup::create",function(t,e){return e.isGroup===!0&&e.options.keyboard===!0&&i.attach({escape:$.proxy(e.close,e),left:$.proxy(e.prev,e),right:$.proxy(e.next,e)}),!1}),e.on("popup::close",function(t,e){return e.isGroup===!0&&e.options.keyboard===!0&&i.detach(),!1})}(document),function(t){var e=$(t),i={timer:{},clear:function(){clearTimeout(this.timer)},set:function(t){this.clear(),t.isGroup&&(this.timer=setTimeout($.proxy(t.next,t),t.options.playSpeed))},play:function(t){t.isPaused=!1,this.set(t)},pause:function(t){this.clear(),t.isPaused=!0}};e.on("popup::change",function(t,e){e.options.autoSlide===!0&&i.play(e)}),e.on("popup::close",function(t,e){e.options.autoSlide===!0&&i.pause(e)})}(document),function(t){var e=$(t),i={tpl:'<div class="popup-thumb-wrap"><button class="popup-thumb-prev" alt="prev">prev</button><div class="popup-thumb"><ul class="popup-thumb-items"></ul></div><button class="popup-thumb-prev" alt="next">next</buttom></div>',map:{none:"",iframe:"",ajax:"",vhtml5:""},init:function(t){var e=this,i=t.group;this.$tpl=$(this.tpl),this.$thumb=this.$tpl.find(".popup-thumb"),this.$items=this.$tpl.find(".popup-thumb-items"),this.$prev=this.$tpl.find(".popup-thumb-prev"),this.$next=this.$tpl.find(".popup-thumb-next"),this.total=i.length,this.index=0,this.posIndex=0,this.showCount=8,this.width=75,$.each(i,function(t,i){var n,o=new Image;n=i.options&&i.options.thumb?i.options.thumb:e.map[i.type]?e.map[i.type]:sel.map.none,o.src=n,$("<li></li>").append(o).appendTo(e.$items)}),this.$items.css({width:75*this.total}),this.$prev.on("click",$.proxy(this.prev,this)),this.$next.on("click",$.proxy(this.prev,this)),this.$thumb.delegate("li","click",function(){var i=e.$items.find("li").index(this);return t.goto(i),!1}),this.$tpl.appendTo(t.$container),this.resize(t),this.active(t.index)},close:function(t){this.unbindEvent(),this.$tpl.remove(),t.$container.removeClass("popup-thumb-layout")},active:function(t){var e="popup-thumb-active";this.$items.find(".popup-thumb-active").removeClass(e),this.$items.find("li").eq(t).addClass(e),this.index=t,this.resetPos(t)},resetPos:function(t){var e=75*t;return t>=this.posIndex&&this.showCount+this.posIndex>t?!1:(this.posIndex>t?(this.posIndex=t,e=t*this.width):(this.posIndex=this.showCount+2*this.posIndex-t+1,e=this.posIndex*this.width),this.$items.css({"margin-left":-e}),undefined)},prev:function(){var t=this.posIndex;return t--,0>t&&(t=this.total-1),this.resetPos(t),!1},next:function(){var t=this.posIndex;return t++,t>=this.total&&(t=0),this.resetPos(t),!1},unbindEvent:function(){this.$prev.off("click"),this.$next.off("click"),this.$items.undelegate("click")},setShowCount:function(t){this.showCount=t,this.total<this.showCount&&(this.showCount=this.total)},resize:function(t){var e,i=t.$container.width();return 500>i?(this.$tpl.css({display:"none"}),t.$container.removeClass("popup-thumb-layout"),!1):(this.$tpl.css({display:"block"}),t.$container.addClass("popup-thumb-layout"),e=Math.round(.8*i/this.width),this.setShowCount(e),undefined)}};e.on("popup::create",function(t,e){e.options.thumbnail&&(e.$container.addClass("popup-thumb-layout"),i.init(e))}),e.on("popup::change",function(t,e){e.options.thumbnail&&i.active(e.index)}),e.on("popup::close",function(t,e){e.options.thumbnail&&i.close(e)}),e.on("popup::resize",function(t,e){e.options.thumbnail&&i.resize(e)}),e.on("popup::preload",function(){})}(document);